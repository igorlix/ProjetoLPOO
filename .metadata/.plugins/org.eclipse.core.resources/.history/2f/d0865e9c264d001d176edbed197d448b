package main;


import javax.swing.*;

import controle.controle;
import controle.movimento;
import modelos.blocos;
import modelos.tabuleiro;


import java.awt.*;


public class logica extends JPanel {

    public static int PANEL_WIDTH = 600;
    public static int PANEL_HEIGHT = 600;
    private final tabuleiro tabuleiro;

    static {
        PANEL_WIDTH += blocos.WIDTH;
        PANEL_HEIGHT += blocos.HEIGHT;
    }

    public logica(int difficulty) {
        tabuleiro = new tabuleiro(difficulty);
        loadPreferences();
        addActionListeners();

    }

    final void loadPreferences() {
        this.setPreferredSize(new Dimension(PANEL_WIDTH, PANEL_HEIGHT));
        this.setBackground(Color.BLACK);
        this.setFocusable(true);
        this.setLayout(null);
    }

    @Override
    protected void paintComponent(Graphics g) {
        super.paintComponent(g);
        Graphics2D g2D = (Graphics2D) g;
        g2D.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
        drawGrid(g2D);
        loadbloco();
       // drawStartMessage(g2D);
    }

    private void drawGrid(Graphics g) {

        g.setColor(Color.black);
        Graphics2D g2 = (Graphics2D) g;

        for (int i = 0; i <= tabuleiro.getN(); i++) {
            g2.drawLine(blocos.WIDTH / 2 + i * blocos.WIDTH, blocos.HEIGHT / 2, blocos.WIDTH / 2 + i * blocos.WIDTH, PANEL_HEIGHT - blocos.HEIGHT / 2);
        }

        for (int i = 0; i <= tabuleiro.getN(); i++) {
            g2.drawLine(blocos.WIDTH / 2, blocos.HEIGHT / 2 + blocos.HEIGHT * i, PANEL_WIDTH - blocos.WIDTH / 2, blocos.WIDTH / 2 + blocos.WIDTH * i);
        }
    }

    private void addActionListeners() {
        for (blocos[] bloco : tabuleiro.getBoard()) {
            for (blocos blocos : bloco) {
                blocos.addActionListener(e -> {
                    if (moveblocos(blocos))
                        repaint();
                    if (checkWinCondition()){
                        //movimento.victoryAnimation(tabuleiro.getBoard(),this);
                        JOptionPane.showMessageDialog(null, "WIN", "!Congrats", JOptionPane.INFORMATION_MESSAGE);
                    }
                });
            }
        }
    }

    private void loadbloco() {

        for (int i = 0; i < tabuleiro.getN(); i++) {
            for (int j = 0; j < tabuleiro.getN(); j++) {
                blocos blocos = tabuleiro.getBoard()[i][j];
                controle.botoes(this,
                        blocos,
                        blocos.getValue(),
                        !blocos.isespacoVazio(),
                        blocos.getX(),
                        blocos.getY(),
                        modelos.blocos.WIDTH * 9 / 10,
                        modelos.blocos.HEIGHT * 9 / 10);
            }
        }
    }

    public void debug(blocos blocos) {

        int x1 = (modelos.blocos.HEIGHT / 2 + blocos.getY()) / modelos.blocos.HEIGHT - 1;
        int y1 = (blocos.getX() + modelos.blocos.WIDTH / 2) / modelos.blocos.WIDTH - 1;

        System.out.println("[" + x1 + "][" + y1 + "]" + " with value " + tabuleiro.getBoard()[x1][y1].getValue() + " ==? " +
                "blocos at position " + "(" + blocos.getX() + "," + blocos.getY() + ")" + " with value " + blocos.getValue());

    }

    public boolean moveblocos(blocos blocos) {

        if (!hasNeighbourespacoVazio(blocos)) {
            System.out.println(blocos.getValue() + " has not an neighbour empty blocos");
            return false;
        }

        blocos espacoVazio = determineespacoVazio();

       movimento.movimentoBlocos(blocos, espacoVazio, this);

        swapWith(blocos);

        return true;
    }

    public blocos determineespacoVazio() {
        for (blocos[] bloco : tabuleiro.getBoard()) {
            for (blocos blocos : bloco) {
                if (blocos.isespacoVazio())
                    return blocos;
            }
        }
        return null;
    }

    public void swapWith(blocos clickedblocos) {
        blocos espacoVazio = determineespacoVazio();

        int x1 = (blocos.HEIGHT / 2 + clickedblocos.getY()) / blocos.HEIGHT - 1;
        int y1 = (clickedblocos.getX() + blocos.WIDTH / 2) / blocos.HEIGHT - 1;


        int x2 = (blocos.HEIGHT / 2 + espacoVazio.getY()) / blocos.HEIGHT - 1;
        int y2 = (espacoVazio.getX() + blocos.WIDTH / 2) / blocos.HEIGHT - 1;

        blocos temp = tabuleiro.getBoard()[x1][y1];
        tabuleiro.getBoard()[x1][y1] = tabuleiro.getBoard()[x2][y2];
        tabuleiro.getBoard()[x2][y2] = temp;

    }

    public boolean hasNeighbourespacoVazio(blocos blocos) {

        int x1 = (modelos.blocos.HEIGHT / 2 + blocos.getY()) / modelos.blocos.HEIGHT - 1;
        int y1 = (blocos.getX() + modelos.blocos.WIDTH / 2) / modelos.blocos.WIDTH - 1;


        blocos[][] board = tabuleiro.getBoard();

        try {
            if (board[x1][y1 + 1].isespacoVazio()) // blocos below is empty blocos
                return true;
        } catch (ArrayIndexOutOfBoundsException ignored) {
        }

        try {
            if (board[x1][y1 - 1].isespacoVazio()) // blocos above is empty blocos
                return true;
        } catch (ArrayIndexOutOfBoundsException ignored) {

        }
        try {
            if (board[x1 - 1][y1].isespacoVazio()) // left blocos is empty blocos
                return true;

        } catch (ArrayIndexOutOfBoundsException ignored) {

        }
        try {
            if (board[x1 + 1][y1].isespacoVazio()) // right below is empty blocos
                return true;

        } catch (ArrayIndexOutOfBoundsException ignored) {
        }

        return false;
    }


    public boolean checkWinCondition() {
        StringBuilder currentPattern = new StringBuilder();
        for (blocos[] bloco : tabuleiro.getBoard()) {
            for (blocos blocos : bloco) {
                currentPattern.append(blocos.getValue());
            }
        }
        return currentPattern.toString().equals(generateWinPattern());
    }

    private String generateWinPattern() {
        StringBuilder pattern = new StringBuilder();
        for (int i = 0; i < tabuleiro.getN() * tabuleiro.getN(); i++) {
            pattern.append(i + 1);
        }
        return pattern.toString();
    }

}
